<!doctype html>
<html>

<head>
    <title>Gamez Central</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.8/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="./GC.css">

    <style>
        /* Loading screen styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            /* Ensure the loading screen is on top */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
            /* Smooth transition for opacity */
        }

        .loading-bar {
            width: 80%;
            max-width: 400px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            transition: width 2s ease;
            /* Smooth transition for width */
        }

        /* GIF container styles */
        .gif-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9998;
            /* Ensure the GIF container is below the loading screen */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            /* Semi-transparent background */
        }

        /* Hide the GIF container initially */
        .hidden {
            display: none;
        }

        /* Start screen styles (I called it "option-screen" to generalize it more). */
        .option-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 24px;
        }

        .option-screen button {
            padding: 10px 20px;
            background-color: #4caf50;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            width: 30%;
        }

        #riskLocalMultiplayerGameSettings button {

        }

    </style>

</head>

<audio id="audio" src="./Media/gamez/etc/audio/BattleMusic.mp3"></audio>

<body class="ln">

    <!-- Loading screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-bar">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <!-- GIF container -->
    <div class="gif-container hidden" id="gifContainer">
        <!-- Insert your GIF embed code here -->
        <div class="tenor-gif-embed" data-postid="10565650" data-share-method="host" data-aspect-ratio="1.77778"
            data-width="100%"><a href="https://tenor.com/view/risk-game-board-game-gif-10565650">Risk Game GIF</a>from
            <a href="https://tenor.com/search/risk-gifs">Risk GIFs</a></div>
        <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
    </div>

    <div class="ui top fixed menu">
        <div class="item" style="margin: 0px; padding: 5px 0px 0px 5px">
            <a href="../index.html"><img src="./Media/logo.png" width="50px"></a>
        </div>
        <a class="item page" href="./risk.html">Risk</a>
        <a class="item page" href="./chess.html">Chess</a>
        <a class="item page" href="./tictactoe.html">Tic-Tac-Toe</a>
        <a class="item page" href="./leaderboard.html">Leaderboard</a>
        <a class="item page" href="./credits.html">Credits</a>
        <div class="right item dropdown" style="margin-right: 5px; padding: 5px 0px 0px 5px">
            <img src="./Media/Store/shoppingcart.png" id="shoppingCart" width="20px"
                style="margin-right: 10px; display:none;">
            <p id="cartItemCount"
                style="position: absolute; top: 4px; right: 124px; background-color: red; color: white; border-radius: 50%; padding: 3px 5px; font-size: 12px; display: none;">
            </p>
            <img src="./Media/Store/coin.png" id="coin" width="20px">
            <p id="balanceTop" style="margin-right:10px"></p>
            <object id="accountImage" data="./Media/profile/account.png" width="40px" style="margin:0px"
                type="image/png" class="avatar-svg">
                <img src="./Media/profile/account.png" width="40px" alt="Avatar 1" />
            </object>
            <div class="dropdown-content">
                <a id="loginLink" href="./login.html">Login</a> <!--Displayed when logged out, hidden when logged in -->
                <a id="signupLink" href="./signup.html">Sign Up</a>
                <!--Displayed when logged out, hidden when logged in -->
                <a id="profileLink" href="./profile.html" style="display:none;">Profile</a>
                <!--Hidden when logged out, showing when logged in -->
                <a id="storeLink" href="./store.html" style="display:none;">Store</a>
                <!--Hidden when logged out, showing when logged in -->
                <a id="cartLink" href="./cart.html" style="display:none;">Cart</a><!--Hidden when logged out, showing when logged in -->
                <a id="logoutLink" href="#" style="display:none;">Logout</a>
                <!--Hidden when logged out, showing when logged in -->
            </div>
        </div>
    </div>

    <h1>Risk</h1>

    <div class="ui container">
        <div class="item body">
            <div class="ui vertical icon menu"> <!--game side bar menu-->
                <span style="font-size: 20px;"> <!-- icon color / styling-->
                    <ul style="display: inherit; padding: inherit;">
                        <li class="dropdown" style="display: block;"><!-- ::marker fix-->
                            <a class="item"> <!-- volume control -->
                                <button id="toggleBtn" onclick="togglePlayPause()" style="background-color: inherit;">
                                    <span style="color: tomato;">
                                        <i id="icon" class="fa-solid fa-volume-xmark"></i>
                                    </span>
                                </button>
                                <div class="dropdown-content"> <!-- volume slider-->
                                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1"
                                        onchange="setVolume(this.value)">
                                </div>
                            </a>
                        </li>
                    </ul>
                    <a class="item"> <!-- Achievements? -->
                        <span style="color: goldenrod;">
                            <i class="fa-solid fa-trophy"></i>
                        </span>
                    </a>
                </span>
            </div>
        </div>
        <div id="game-container" class="item body" style="margin: auto;"> <!-- game -->
            <div id="inside-game-container" class="ui fluid container" style=" border:1px dashed black; width:800px; height:560px;">
                <div class="option-screen" id="startScreen">
                    <h1>Welcome to Risk</h1>
                    <button onclick="startGame()">Play</button>
                    <button onclick="riskSettingsPage()">Settings</button>
                    <button onclick="riskHowTo()">How to Play</button>
                    <button onclick="openFullscreen()">Fullscreen</button>
                </div>
                <div class="option-screen" id="gameModeOptions" style="display:none">
                    <h1>Select Game Mode</h1>
                    <button onclick="riskOnlineGame()">Play - Online</button>
                    <button onclick="riskComputerGame()">Play - Computer(s)</button>
                    <button onclick="riskLocalMultiplayerGame()">Play - Local Multiplayer</button>
                </div>
                <div id="riskLocalMultiplayerGameScreen">
                    <div class="option-screen" id="riskLocalMultiplayerGameSettings" style="display:none">
                        <h1>Choose Settings</h1>
                        <div id="riskLocalMultiplayerGameSettingsNumberOfPlayers">
                            <h2>Number of Players</h2>
                            <button onclick="decreasePlayer()">-</button>
                            <span id="playerCount">1</span>
                            <button onclick="increasePlayer()">+</button>
                            <h2>Number of AI Opponents</h2>
                            <button onclick="decreaseAI()">-</button>
                            <span id="aiCount">1</span>
                            <button onclick="increaseAI()">+</button>
                            <button onclick="generatePlayerNameInput(0)">Next</button>
                        </div>
                        <div id="riskLocalMultiplayerGameSettingsPlayersNames" style="display:none">
                            <h1>Choose Player Names</h1>
                        </div>
                    </div>
                </div>
                <object type="text/html" data="./Media/gamez/riskMaps/riskSVGMap/RiskMapSVGRiskPage.html" width="100%"
                    height="100%">
                    Your browser does not support SVG
                </object>
            </div>
        </div>
        <div id="ad-container"><!-- will change ad placment -->
            <!-- hardcoded -->
        </div>
    </div>

    <div id="output">
        <!-- AI generated-->
    </div>

</body>

<footer>
    <div class="ui inverted bottom fixed menu">
        <div class="item">
            <p>2024 © Copyright Gamez Central. All rights Reserved.</p>
        </div>
        <div class="item">
            <p>CSS provided by Fomantic-UI</p>
        </div>
    </div>
</footer>

<script src="https://kit.fontawesome.com/72c730bbf1.js" crossorigin="anonymous"></script>
<script src="./scripts/audio.js"></script>
<script src="./scripts/anim.js"></script>
<script src="./scripts/script.js"></script>
<script src="./scripts/randAds.js"></script>

<script>

    // Call the function to fetch and update data when the page loads
    window.onload = function () {
        fetchBalanceAndAvatar();
        checkCart();
    };

</script>

<!-- JavaScript to simulate loading progress and show/hide loading screen -->
<script>
    // Simulate loading progress
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const loadingScreen = document.getElementById('loadingScreen');
    const gifContainer = document.getElementById('gifContainer');

    function simulateLoading() {
        const interval = setInterval(() => {
            progress += 10; // Increment progress
            progressBar.style.width = progress + '%'; // Update progress bar width
            if (progress >= 100) {
                clearInterval(interval); // Stop the interval when progress reaches 100%
                setTimeout(() => {
                    loadingScreen.style.opacity = 0; // Fade out loading screen
                    setTimeout(() => {
                        loadingScreen.style.display = 'none'; // Hide loading screen
                    }, 500); // After fade out animation
                    setTimeout(() => {
                        gifContainer.classList.add('hidden');
                    }, 2130); // After fade out animation
                }, 1000); // Wait for 1 second before fading out
            }
        }, 500); // Interval duration
    }

    // Show the GIF container initially, then start simulating loading
    gifContainer.classList.remove('hidden');
    setTimeout(() => {
        simulateLoading();
    }, 2000); // Show GIF container after 2 seconds

    function startGame() {
        var startScreen = document.getElementById("startScreen");
        var gameModeOptions = document.getElementById("gameModeOptions");

        startScreen.style.display = 'none';
        gameModeOptions.style.display = 'flex';
    }

    /* Get the relevant elements to be displayed in fullscreen mode*/
    var gameContainer = document.getElementById("game-container");
    var insideGameContainer = document.getElementById('inside-game-container');
    var contentWidth = insideGameContainer.style.width;
    var contentHeight = insideGameContainer.style.height;

    /* The next few functions pertain to the settings page that displays when the local multiplayer game mode is selected. */
    function riskLocalMultiplayerGame() {
        var gameModeOptions = document.getElementById("gameModeOptions");
        var riskLocalMultiplayerGameSettings = document.getElementById("riskLocalMultiplayerGameSettings");

        gameModeOptions.style.display = 'none';
        riskLocalMultiplayerGameSettings.style.display = 'flex';
    }

    var playerCount = 1; // Initial number of total players

    function increasePlayer() {
        if (playerCount < 6) {
            if(playerCount + aiCount >= 5 && aiCount > 0) {
                aiCount--;
            }
            playerCount++;
            if(playerCount === 1 && aiCount === 0) {
                aiCount = 1;
            }
            document.getElementById("playerCount").textContent = playerCount;
            document.getElementById("aiCount").textContent = aiCount;
        }
    }

    function decreasePlayer() {
        if (playerCount > 1) {
            playerCount--;
            if(playerCount === 1 && aiCount === 0) {
                aiCount = 1;
            }
            document.getElementById("playerCount").textContent = playerCount;
            document.getElementById("aiCount").textContent = aiCount;
        }
    }

    var aiCount = 1; // Initial number of AI opponents

    function increaseAI() {
        if (aiCount < 5) {
            if(aiCount + playerCount >= 5 && playerCount > 1) {
                playerCount--;
            }
            aiCount++;
            if(playerCount === 1 && aiCount === 0) {
                aiCount = 1;
            }
            document.getElementById("playerCount").textContent = playerCount;
            document.getElementById("aiCount").textContent = aiCount;
        }
    }

    function decreaseAI() {
        if (aiCount > 0) {
            aiCount--;
            if(playerCount === 1 && aiCount === 0) {
                aiCount = 1;
            }
            document.getElementById("playerCount").textContent = playerCount;
            document.getElementById("aiCount").textContent = aiCount;
        }
    }

    // Get the div where player names will be added
    var risklocalMultiplayerGameSettingsScreen = document.getElementById("riskLocalMultiplayerGameSettings")
    var numberOfPlayersDiv = document.getElementById("riskLocalMultiplayerGameSettingsNumberOfPlayers");
    var playersNamesDiv = document.getElementById("riskLocalMultiplayerGameSettingsPlayersNames");
    // Variable to store player names
    var playerNames = [];
    
     // Function to generate input field for player names one at a time
     function generatePlayerNameInput(playerIndex) {
        numberOfPlayersDiv.style.display = 'none';
        playersNamesDiv.style.display = 'flex';

        // Clear previous content
        playersNamesDiv.innerHTML = '';

        // Create label for the current player
        var playerNameLabel = document.createElement("label");
        playerNameLabel.textContent = "Enter name for Player " + (playerIndex + 1) + ":";
        playersNamesDiv.appendChild(playerNameLabel);

        // Create input field for the current player
        var playerNameInput = document.createElement("input");
        playerNameInput.type = "text";
        playerNameInput.placeholder = "Enter name";
        playerNameInput.id = "playerNameInput";
        playersNamesDiv.appendChild(playerNameInput);

        // Create button to submit the name
        var submitButton = document.createElement("button");
        submitButton.textContent = "Submit";
        submitButton.onclick = function() {
            // Get the value entered by the user
            var playerName = playerNameInput.value;
            // Add the name to the array
            playerNames.push(playerName);
            // If there are more players, generate input field for the next player
            if (playerIndex < playerCount - 1) {
                generatePlayerNameInput(playerIndex + 1);
            } else {
                // If all players have entered their names, do something (e.g., start the game)
                console.log("All player names submitted:", playerNames);
                playersNamesDiv.style.display = 'none';
                risklocalMultiplayerGameSettingsScreen.style.display = 'none';
                newRiskLocalGame();
            }
        };
        playersNamesDiv.appendChild(submitButton);
    }

    async function newRiskLocalGame() {
        if(aiCount > 0) {
            for(i = 1; i <= aiCount; i++) {
                playerNames.push("Computer" + "(" + i  + ")");
            }
        }

        const userData = await getData();
        console.log(userData);
        if(userData) {
            const gameInfo = {
                playerNames,
                gameMode: 'Local'
            };
            try {
                const response = await fetch('/insert-riskLocalGame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData._id,
                        gameInfo: gameInfo
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to insert risk local game');
                }

                const data = await response.json();
                console.log('Local risk game inserted successfully');
                console.log('Starting local risk game...');
                playRiskLocalGame();
            } catch (error) {
            console.error('Error inserting local risk game:', error);
            }
        }
    }

    // Originally I had two functions: startRiskLocalGame() and resumeRiskLocalGame(), I decided to combine them and 
    // generalize them for simplification purposes. Anyway, this function gets the userData to then get the game info.
    async function playRiskLocalGame() {
        const userData = await getData();
        const gameData = await getLocalRiskGameData(userData._id);
        console.log("Local risk game data: " + JSON.stringify(gameData, null, 2));
    }

    async function getLocalRiskGameData(userId) {
        try {
            // Fetch user data using token
            const response = await fetch('/riskLocalGame-data', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${userId}`,
                    'Content-Type': 'application/json'
                }
            });

            // Check if response is successful
            if (!response.ok) {
                throw new Error('Failed to fetch game data');
            }

            // Parse response data
            const data = await response.json();
            return data;
        } catch (error) {
            // Log error if fetching game data fails
            console.error('Error with game:', error);
            throw error;
        }
    }

    /* This functions main goal is to call the reqeustFullscreen() method. The rest of the code in the function 
    is just making sure the content in the full screen mode is scaled and placed properly. */
    function openFullscreen() {
        if (gameContainer.requestFullscreen) {
            gameContainer.requestFullscreen();

            // Calculate the scaling factor based on the screen width. This is just to make sure the full screen mode fits most screens.
            var screenWidth = window.screen.width;
            var screenHeight = window.screen.height;
            var minScalingFactor = 0.8; // Adjust as needed
            var maxScalingFactor = 0.9; // Adjust as needed

            // Calculate the scaling factor based on the screen width
            var scalingFactor = Math.max(2, screenWidth / 800); // This is based off of my laptop screen as a reference hence the seemingly arbitrary numbers.
            
            // Set the width and height of the insideGameContainer based on the scaling factor
            if(scalingFactor === 2) {
                insideGameContainer.style.width = screenWidth * maxScalingFactor + "px";
                insideGameContainer.style.height = screenHeight + "px";
            }
            else {
                insideGameContainer.style.width = screenWidth * minScalingFactor + "px";
                insideGameContainer.style.height = screenHeight + "px";
            }
            gameContainer.style.justifyContent = 'center';
            gameContainer.style.alignItems = 'center';
            gameContainer.style.display = 'flex';
        } 
    }

    document.addEventListener('fullscreenchange', exitFullscreenHandler);

    function exitFullscreenHandler() {
        if (!document.fullscreenElement) {
            // If the fullscreenElement is null, it means the user has exited fullscreen mode
            insideGameContainer.style.width = contentWidth; // Reset width to default
            insideGameContainer.style.height = contentHeight; // Reset height to default
            gameContainer.style.justifyContent = ''; // Reset justifyContent
            gameContainer.style.alignItems = ''; // Reset alignItems
            gameContainer.style.display = ''; // Reset display
            gameContainer.style.transform = ''; // Reset transform (scaling)
        }
    }

</script>

</html>